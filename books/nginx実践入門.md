# nginx 実践入門

https://www.amazon.co.jp/dp/B07JHJF3NQ

> - 第1章：nginxの概要とアーキテクチャ
> - 第2章：インストールと起動
> - 第3章：基本設定
> - 第4章：静的なWebサイトの構築
> - 第5章：安全かつ高速なHTTPSサーバの構築
> - 第6章：Webアプリケーションサーバの構築
> - 第7章：大規模コンテンツ配信サーバの構築
> - 第8章：Webサーバの運用とメトリクスモニタリング
> - 第9章：Luaによるnginxの拡張──Embed Lua into nginx
> - 第10章：OpenResty──nginxベースのWebアプリケーションフレームワーク

# 学んだこと

## nginx のアーキテクチャ

nginx のアーキテクチャは「イベント駆動型」・「マスターワーカープロセス」を採用しています。

イベント駆動型は、イベントに対応したコールバック関数が呼ばれるというものです。
例えば、HTTP サーバーで発生するイベント以下があります。

- クライアントからの接続要求（accept）
- クライアントとの通信用ディスクリプタが読み込み可能になる（read）
- クライアントとの通信用ディスクリプタが書き込み可能になる（write）

これらのイベントに応じたコールバックが呼ばれることになりますが、1つのプロセス内で複数のクライアントのディスクリプタとの入出力を並行して行います。
一方で、prefork モデルを採用している Apache などでは、クライアントの接続要求から始まる一連の処理の流れを各プロセスで1接続ずつ処理します。そのため、接続数分プロセスを起動します。

よって、prefork モデルよりもイベント駆動型の方が、少ないプロセス数で処理できます。それにより、プロセス間のコンテキストスイッチによるオーバーヘッドがなくなり、高いパフォーマンスが実現できます。

## 各ディレクティブの意味

本書では多くのディレクティブが解説されていました。その中で、印象に残ったディレクティブを挙げます。

- try_files
  - 指定されたファイルパスが存在する場合はその内容を返し、存在しない場合には最後に指定した URI にリダイレクトする
- events
  - ワーカーのイベント駆動方式に関連するディレクティブ
  - worker_connections でワーカーが処理数コネクション数を設定
  - use でコネクションの処理方法を指定する
    - Linux2.6 epoll が効率的で最適になる


## 負荷に対するアプローチ

CPU、ディスクI/O、ネットワークの負荷に対するアプローチには大きく分けて以下があります。

1. 1台で処理できる量を増やす(スケールアップ・チューニング)
2. 複数台で処理して、1台あたりの負荷を下げる(スケールアウト)

1については、ハードウェアをよりよいものにしたり、アルゴリズム、DB のインデックスなどを駆使して、サーバー自体の処理能力を向上させるアプローチです。
短期的な負荷削減効果があるものの、チューニングには限界がありコストが上がる問題もあります。

2については、キャッシュといったアプローチがあります。
キャッシュサーバーを自前で立てるか、CDNを利用することにより、オリジンサーバーからコンテンツを取得する際のファイル読み込み量が減り、パフォーマンス向上が見込めます。

キャッシュを使う場合、参照頻度が低いコンテンツへの大量のリクエストによって、参照頻度が高いコンテンツがキャッシュから追い出され、キャッシュヒット率が低下することもあります。

そのため、ロードバランスを用いたキャッシュクラスタを構築する必要があります。
ロードバランスには以下の種類があります。

- L4ロードバランサ
  - TCP コネクションごとにロードバランスする
  - TCP を利用していれば、どのプロトコルでもバランシングができる
- L7ロードバランサ
  - HTTP リクエストごとに振り分ける
  - コンテンツの種類やリクエストの内容に応じた細かな負荷分散が可能
- DNSラウンドロビンによる分散
  - DNSを利用して、1つのドメインに対し複数のアドレスの順番を入れ替えながら応答する方法
